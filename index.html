<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Planner Settimanale</title>
    <style>
        /* Same styles as before */
    </style>
</head>
<body>
    <header>
        <h1 id="week-title">Settimana</h1>
        <button id="prev-week">&larr; Settimana Precedente</button>
        <button id="next-week">Settimana Successiva &rarr;</button>
    </header>
    <main>
        <div class="container" id="planner-container"></div>
    </main>
    <footer>
        <div class="legend">
            <div><span class="blue"></span> Marco</div>
            <div><span class="orange"></span> Laura</div>
            <div><span class="red"></span> Abies</div>
            <div><span class="white"></span> Non prenotato</div>
        </div>
    </footer>
    <script>
        const CLIENT_ID = '786045326849-4524vek5urhk3lkdpml0kvqev2gboc1l.apps.googleusercontent.com';
        const API_KEY = 'AIzaSyCF2HZo60YJ9AXjWc79isscfwDgW2qzwmc';
        const DISCOVERY_DOCS = ["https://sheets.googleapis.com/$discovery/rest?version=v4"];
        const SCOPES = "https://www.googleapis.com/auth/spreadsheets";

        const SPREADSHEET_ID = "1K90XFVzRNvBbvOo8SfcdDo5KDHE9Tk9aMxP8XevhVZM"; // Replace with your Google Sheets ID
        const days = ["Lunedì", "Martedì", "Mercoledì", "Giovedì", "Venerdì", "Sabato", "Domenica"];
        const timeSlots = ["Mattina", "Pomeriggio", "Sera", "Notte"];
        let currentWeek = new Date();
        let currentWeekData = {};

        function getMonday(d) {
            d = new Date(d);
            const day = d.getDay(),
                diff = d.getDate() - day + (day === 0 ? -6 : 1); // Adjust for Monday (day 1)
            return new Date(d.setDate(diff));
        }

        function formatWeekRange(date) {
            const monday = getMonday(date);
            const sunday = new Date(monday);
            sunday.setDate(monday.getDate() + 6);

            const options = { day: '2-digit', month: '2-digit' };
            return `${monday.toLocaleDateString('it-IT', options)} - ${sunday.toLocaleDateString('it-IT', options)}`;
        }

        function getWeekIdentifier(date) {
            const monday = getMonday(date);
            const year = monday.getFullYear();
            const month = (`0${monday.getMonth() + 1}`).slice(-2);
            const day = (`0${monday.getDate()}`).slice(-2);
            return `${year}-${month}-${day}`;
        }

        function updatePlanner() {
            const plannerContainer = document.getElementById("planner-container");
            const weekTitle = document.getElementById("week-title");

            const weekIdentifier = getWeekIdentifier(currentWeek);
            weekTitle.textContent = `Settimana ${formatWeekRange(currentWeek)}`;
            plannerContainer.innerHTML = "";

            days.forEach((day, dayIndex) => {
                const dayDiv = document.createElement("div");
                dayDiv.className = "day";
                const dayTitle = document.createElement("h2");
                dayTitle.textContent = day;
                dayDiv.appendChild(dayTitle);

                timeSlots.forEach((slot, slotIndex) => {
                    const slotDiv = document.createElement("div");
                    slotDiv.className = "time-slot";
                    slotDiv.textContent = slot;

                    const key = `${dayIndex}-${slotIndex}`;
                    if (currentWeekData[key]) slotDiv.classList.add(currentWeekData[key]);

                    slotDiv.onclick = () => {
                        const colors = ["blue", "orange", "red", ""];
                        const currentColor = slotDiv.className.split(" ").find(cls => colors.includes(cls)) || "";
                        const nextColor = colors[(colors.indexOf(currentColor) + 1) % colors.length];
                        slotDiv.className = `time-slot ${nextColor}`;
                        currentWeekData[key] = nextColor;
                        saveWeekData();
                    };
                    dayDiv.appendChild(slotDiv);
                });

                plannerContainer.appendChild(dayDiv);
            });
        }

        function loadWeekData() {
            const weekIdentifier = getWeekIdentifier(currentWeek);
            gapi.client.sheets.spreadsheets.values.get({
                spreadsheetId: SPREADSHEET_ID,
                range: weekIdentifier,
            }).then(response => {
                const rows = response.result.values || [];
                currentWeekData = {};

                rows.forEach((row, rowIndex) => {
                    row.forEach((value, colIndex) => {
                        if (value) currentWeekData[`${rowIndex}-${colIndex}`] = value;
                    });
                });
                updatePlanner();
            }).catch(() => {
                currentWeekData = {};
                updatePlanner();
            });
        }

        function saveWeekData() {
            const weekIdentifier = getWeekIdentifier(currentWeek);
            const data = Array(7).fill(null).map((_, dayIndex) =>
                Array(4).fill(null).map((_, slotIndex) =>
                    currentWeekData[`${dayIndex}-${slotIndex}`] || ""
                )
            );

            gapi.client.sheets.spreadsheets.values.update({
                spreadsheetId: SPREADSHEET_ID,
                range: weekIdentifier,
                valueInputOption: "RAW",
                resource: { values: data },
            }).then(() => {
                console.log("Data saved successfully.");
            }).catch(error => {
                console.error("Error saving data:", error);
            });
        }

        function handleClientLoad() {
            gapi.load('client:auth2', initClient);
        }

        function initClient() {
            gapi.client.init({
                apiKey: API_KEY,
                clientId: CLIENT_ID,
                discoveryDocs: DISCOVERY_DOCS,
                scope: SCOPES,
            }).then(() => {
                gapi.auth2.getAuthInstance().isSignedIn.listen(updateSigninStatus);
                updateSigninStatus(gapi.auth2.getAuthInstance().isSignedIn.get());
            });
        }

        function updateSigninStatus(isSignedIn) {
            if (isSignedIn) {
                loadWeekData();
            } else {
                gapi.auth2.getAuthInstance().signIn();
            }
        }

        document.getElementById("prev-week").onclick = () => {
            currentWeek.setDate(currentWeek.getDate() - 7);
            loadWeekData();
        };

        document.getElementById("next-week").onclick = () => {
            currentWeek.setDate(currentWeek.getDate() + 7);
            loadWeekData();
        };

        document.addEventListener("DOMContentLoaded", () => {
            const script = document.createElement("script");
            script.src = "https://apis.google.com/js/api.js";
            script.onload = handleClientLoad;
            document.body.appendChild(script);
        });
    </script>
</body>
</html>
